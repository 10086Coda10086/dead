<div class="app-chart-container">
    <h3>{{ c.title }}</h3>
    <p>{{ c.description }}</p>

    <div class="chart-controls">
        <label for="days-select">显示时间范围：</label>
        <select id="days-select">
            <option value="7" {% if c.default_days == 7 %}selected{% endif %}>最近7天</option>
            <option value="14" {% if c.default_days == 14 %}selected{% endif %}>最近14天</option>
            <option value="30" {% if c.default_days == 30 %}selected{% endif %}>最近30天</option>
        </select>
    </div>

    <div class="chart-container" style="position: relative; height: {{ c.chart_height }}px;">
        <canvas id="app-usage-chart"></canvas>
    </div>

    <div class="chart-legend" id="chart-legend">
        <div class="loading">加载中...</div>
    </div>

    <div class="chart-summary" id="chart-summary">
        <h4>总使用时间排名</h4>
        <div class="loading">加载中...</div>
    </div>

    <div class="overall-stats" id="overall-stats">
        <h4>总体统计</h4>
        <div class="loading">加载中...</div>
    </div>
</div>

<!-- 引入 Chart.js -->
<script src="/static/chart.min.js?theme={{ current_theme }}"></script>

<style>
.app-chart-container {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
}

.chart-controls {
    margin-bottom: 15px;
}

.chart-controls select {
    padding: 5px 10px;
    border-radius: 4px;
    border: 1px solid #ccc;
}

.chart-legend {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 15px;
}

.legend-item {
    display: flex;
    align-items: center;
    margin: 5px 10px;
}

.legend-color {
    width: 15px;
    height: 15px;
    margin-right: 5px;
    border-radius: 3px;
}

.chart-summary, .overall-stats {
    margin-top: 20px;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(128, 128, 128, 0.2);
}

.summary-item:last-child {
    border-bottom: none;
}

.summary-bar-container {
    flex-grow: 1;
    margin: 0 10px;
    background-color: rgba(128, 128, 128, 0.1);
    border-radius: 3px;
    overflow: hidden;
}

.summary-bar {
    height: 100%;
    min-height: 20px;
}

.stat-card {
    display: inline-block;
    padding: 15px;
    margin: 10px;
    border-radius: 5px;
    text-align: center;
    background-color: rgba(128, 128, 128, 0.1);
    min-width: 120px;
}

.stat-value {
    font-size: 1.5em;
    font-weight: bold;
    margin: 5px 0;
}

.stat-label {
    font-size: 0.9em;
    color: #666;
}

.loading {
    text-align: center;
    color: #888;
    padding: 20px;
}

.error-message {
    color: #e15759;
    text-align: center;
    padding: 20px;
}

.empty-message {
    color: #888;
    text-align: center;
    padding: 20px;
}
</style>

<script>
// 颜色配置
const appColors = {{ c.colors|tojson }};

// 格式化时间函数
function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);

    if (hours > 0) {
        return `${hours}小时${minutes}分钟`;
    } else {
        return `${minutes}分钟`;
    }
}

// 创建图表
let appUsageChart = null;

// 加载数据并创建图表
async function loadChartData(days = 7) {
    try {
        // 显示加载状态
        document.getElementById('chart-legend').innerHTML = '<div class="loading">加载中...</div>';
        document.getElementById('chart-summary').innerHTML = '<h4>总使用时间排名</h4><div class="loading">加载中...</div>';

        // 获取数据
        const response = await fetch(`/plugin/app-chart/stats?days=${days}&limit={{ c.max_apps }}`);
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.message || '加载数据失败');
        }

        const stats = data.stats;
        createChart(stats);
        createLegend(stats);
        createSummary(stats);
    } catch (error) {
        console.error('Error loading chart data:', error);
        document.getElementById('chart-legend').innerHTML = `<div class="error-message">${error.message}</div>`;
        document.getElementById('chart-summary').innerHTML = '<h4>总使用时间排名</h4><div class="error-message">加载数据失败</div>';
    }
}

// 创建图表
function createChart(stats) {
    const ctx = document.getElementById('app-usage-chart').getContext('2d');

    // 如果图表已存在，销毁它
    if (appUsageChart) {
        appUsageChart.destroy();
    }

    // 如果没有应用数据，显示空图表
    if (!stats.apps || stats.apps.length === 0) {
        appUsageChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: stats.dates || [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        return;
    }

    // 准备数据集
    const datasets = stats.apps.map((app, index) => {
        const appData = stats.dates.map(date => {
            if (stats.data[app] && typeof stats.data[app][date] === 'number') {
                return stats.data[app][date] / 60; // 转换为分钟
            }
            return 0;
        });

        return {
            label: app,
            data: appData,
            backgroundColor: appColors[index % appColors.length],
            borderColor: appColors[index % appColors.length],
            borderWidth: 2,
            tension: 0.3,
            fill: false
        };
    });

    // 创建图表
    appUsageChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: stats.dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.raw || 0;
                            return `${label}: ${formatDuration(value * 60)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '使用时间（分钟）'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '日期'
                    }
                }
            }
        }
    });
}

// 创建图例
function createLegend(stats) {
    const legendContainer = document.getElementById('chart-legend');
    legendContainer.innerHTML = '';

    stats.apps.forEach((app, index) => {
        const color = appColors[index % appColors.length];

        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';

        const colorBox = document.createElement('div');
        colorBox.className = 'legend-color';
        colorBox.style.backgroundColor = color;

        const appName = document.createElement('span');
        appName.textContent = app;

        legendItem.appendChild(colorBox);
        legendItem.appendChild(appName);
        legendContainer.appendChild(legendItem);
    });
}

// 创建总结
function createSummary(stats) {
    const summaryContainer = document.getElementById('chart-summary');
    summaryContainer.innerHTML = '<h4>总使用时间排名</h4>';

    // 如果没有应用数据，显示提示信息
    if (!stats.apps || stats.apps.length === 0) {
        summaryContainer.innerHTML += '<div class="empty-message">暂无数据</div>';
        return;
    }

    // 计算每个应用的总使用时间
    const appTotals = stats.apps.map(app => {
        let total = 0;
        for (const date of stats.dates) {
            if (stats.data[app] && typeof stats.data[app][date] === 'number') {
                total += stats.data[app][date];
            }
        }
        return { app, total };
    });

    // 按总时间排序
    appTotals.sort((a, b) => b.total - a.total);

    // 如果没有数据，显示提示信息
    if (appTotals.length === 0 || appTotals[0].total === 0) {
        summaryContainer.innerHTML += '<div class="empty-message">暂无数据</div>';
        return;
    }

    // 找出最大值用于计算百分比
    const maxTotal = appTotals[0].total;

    // 创建总结项
    appTotals.forEach((item, index) => {
        const percent = maxTotal > 0 ? (item.total / maxTotal) * 100 : 0;
        const color = appColors[stats.apps.indexOf(item.app) % appColors.length];

        const summaryItem = document.createElement('div');
        summaryItem.className = 'summary-item';

        const appName = document.createElement('div');
        appName.className = 'summary-app';
        appName.textContent = item.app;

        const barContainer = document.createElement('div');
        barContainer.className = 'summary-bar-container';

        const bar = document.createElement('div');
        bar.className = 'summary-bar';
        bar.style.width = `${percent}%`;
        bar.style.backgroundColor = color;

        const duration = document.createElement('div');
        duration.className = 'summary-duration';
        duration.textContent = formatDuration(item.total);

        barContainer.appendChild(bar);
        summaryItem.appendChild(appName);
        summaryItem.appendChild(barContainer);
        summaryItem.appendChild(duration);
        summaryContainer.appendChild(summaryItem);
    });
}

// 加载总体统计数据
async function loadOverallStats() {
    try {
        const response = await fetch('/plugin/app-chart/summary');
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.message || '加载数据失败');
        }

        const statsContainer = document.getElementById('overall-stats');
        statsContainer.innerHTML = '<h4>总体统计</h4>';

        // 检查是否有数据
        if (!data.apps || data.apps.length === 0) {
            statsContainer.innerHTML += '<div class="empty-message">暂无统计数据</div>';
            return;
        }

        const statsContent = document.createElement('div');
        statsContent.className = 'stats-content';

        // 总使用时间
        const totalTimeCard = document.createElement('div');
        totalTimeCard.className = 'stat-card';

        const totalTimeValue = document.createElement('div');
        totalTimeValue.className = 'stat-value';
        totalTimeValue.textContent = formatDuration(data.total_time || 0);

        const totalTimeLabel = document.createElement('div');
        totalTimeLabel.className = 'stat-label';
        totalTimeLabel.textContent = '总使用时间';

        totalTimeCard.appendChild(totalTimeValue);
        totalTimeCard.appendChild(totalTimeLabel);

        // 应用数量
        const appCountCard = document.createElement('div');
        appCountCard.className = 'stat-card';

        const appCountValue = document.createElement('div');
        appCountValue.className = 'stat-value';
        appCountValue.textContent = data.apps ? data.apps.length : 0;

        const appCountLabel = document.createElement('div');
        appCountLabel.className = 'stat-label';
        appCountLabel.textContent = '追踪的应用';

        appCountCard.appendChild(appCountValue);
        appCountCard.appendChild(appCountLabel);

        // 最常用应用
        if (data.apps && data.apps.length > 0 && data.apps[0].app_name) {
            const topAppCard = document.createElement('div');
            topAppCard.className = 'stat-card';

            const topAppValue = document.createElement('div');
            topAppValue.className = 'stat-value';
            topAppValue.textContent = data.apps[0].app_name;

            const topAppLabel = document.createElement('div');
            topAppLabel.className = 'stat-label';
            topAppLabel.textContent = '最常用应用';

            topAppCard.appendChild(topAppValue);
            topAppCard.appendChild(topAppLabel);

            statsContent.appendChild(topAppCard);
        }

        statsContent.appendChild(totalTimeCard);
        statsContent.appendChild(appCountCard);

        statsContainer.appendChild(statsContent);
    } catch (error) {
        console.error('Error loading overall stats:', error);
        document.getElementById('overall-stats').innerHTML = '<h4>总体统计</h4><div class="error-message">加载数据失败: ' + error.message + '</div>';
    }
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    // 加载初始数据
    const defaultDays = parseInt(document.getElementById('days-select').value);
    loadChartData(defaultDays);
    loadOverallStats();

    // 监听选择框变化
    document.getElementById('days-select').addEventListener('change', function() {
        const days = parseInt(this.value);
        loadChartData(days);
    });
});
</script>
