<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ c.page.name }} - 管理面板</title>
    <meta name="description" content="管理面板">
    <link rel="icon" href="{{ c.page.favicon }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .status-item {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        .status-item.active {
            font-weight: bold;
            border: 2px solid #000;
        }

        .metric-card {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
    </style>
    <script>
        // 设置当前主题，供 theme.js 使用
        document.body.setAttribute('data-theme', "{{ current_theme }}");
    </script>
    <script src="{{ url_for('static', filename='theme.js') }}"></script>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1>{{ c.page.name }} 的管理面板</h1>
            <div>
                <button onclick="saveData()">保存数据</button>
                <a href="/">查看前台</a>
                <button onclick="logout()">退出登录</button>
            </div>
        </div>

        <div class="card">
            <h2>状态管理</h2>
            <p>当前状态: <span id="current-status-name">加载中...</span></p>
            <div id="status-selector">
                <!-- 状态选择器将通过 JavaScript 动态生成 -->
            </div>
        </div>

        <div class="card">
            <h2>主题设置</h2>
            <p>当前主题: <span id="current-theme">{{ current_theme }}</span></p>
            <div id="theme-selector">
                {% for theme in available_themes %}
                <div class="status-item {% if current_theme == theme %}active{% endif %}"
                    onclick="switchTheme('{{ theme }}')">{{ theme }}主题</div>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <h2>设备管理</h2>
            <div style="margin-bottom: 15px;">
                <button onclick="clearAllDevices()">清除所有设备</button>
                <div>
                    <input type="checkbox" id="private-mode-toggle" onchange="togglePrivateMode(this.checked)">
                    <label for="private-mode-toggle">隐私模式</label>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>设备ID</th>
                        <th>显示名称</th>
                        <th>使用状态</th>
                        <th>应用名称</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="device-list-body">
                    <!-- 设备列表将通过 JavaScript 动态生成 -->
                </tbody>
            </table>
        </div>

        {% if c.metrics.enabled %}
        <div class="card">
            <h2>访问统计</h2>
            <div id="metrics-container">
                <!-- 统计数据将通过 JavaScript 动态生成 -->
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        // 获取密钥（仅作为备份，主要使用 cookie 进行身份验证）
        const secret = localStorage.getItem('sleepy_secret');

        // 全局变量
        let statusList = [];
        let currentStatus = 0;
        let deviceData = {};
        let privateMode = false;

        // 初始化页面
        async function initPage() {
            try {
                // 获取状态列表
                const statusResponse = await fetch('/status_list');
                statusList = await statusResponse.json();
                renderStatusSelector();

                // 获取当前状态和设备信息
                const queryResponse = await fetch('/query');
                const queryData = await queryResponse.json();
                currentStatus = queryData.status;
                deviceData = queryData.device;
                privateMode = queryData.private_mode || false;

                // 更新UI
                updateCurrentStatus();
                renderDeviceList();
                document.getElementById('private-mode-toggle').checked = privateMode;

                // 如果启用了统计功能，获取统计数据
                if (document.getElementById('metrics-container')) {
                    await fetchMetrics();
                }
            } catch (error) {
                console.error('初始化失败:', error);
                alert('加载数据失败，请检查网络连接或重新登录');
            }
        }

        // 渲染状态选择器
        function renderStatusSelector() {
            const container = document.getElementById('status-selector');
            container.innerHTML = '';

            statusList.forEach((status, index) => {
                const statusItem = document.createElement('div');
                statusItem.className = `status-item ${currentStatus === index ? 'active' : ''}`;
                statusItem.textContent = status.name;
                statusItem.onclick = () => setStatus(index);
                container.appendChild(statusItem);
            });
        }

        // 更新当前状态显示
        function updateCurrentStatus() {
            const statusName = document.getElementById('current-status-name');
            if (statusList[currentStatus]) {
                statusName.textContent = statusList[currentStatus].name;
            } else {
                statusName.textContent = '未知状态';
            }

            // 更新状态选择器中的活动状态
            document.querySelectorAll('.status-item').forEach((item, index) => {
                item.classList.toggle('active', index === currentStatus);
            });
        }

        // 设置状态
        async function setStatus(statusIndex) {
            try {
                const response = await fetch(`/set?status=${statusIndex}`);
                const data = await response.json();

                if (data.success) {
                    currentStatus = statusIndex;
                    updateCurrentStatus();
                } else {
                    alert('设置状态失败: ' + (data.message || '未知错误'));
                }
            } catch (error) {
                console.error('设置状态失败:', error);
                alert('设置状态失败，请检查网络连接');
            }
        }

        // 渲染设备列表
        function renderDeviceList() {
            const tbody = document.getElementById('device-list-body');
            tbody.innerHTML = '';

            if (Object.keys(deviceData).length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="5" style="text-align: center;">暂无设备数据</td>';
                tbody.appendChild(tr);
                return;
            }

            for (const [deviceId, device] of Object.entries(deviceData)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${deviceId}</td>
                    <td>${device.show_name}</td>
                    <td>${device.using ? '使用中' : '未使用'}</td>
                    <td>${device.app_name}</td>
                    <td>
                        <button onclick="removeDevice('${deviceId}')">删除</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }

        // 删除设备
        async function removeDevice(deviceId) {
            if (!confirm(`确定要删除设备 "${deviceId}" 吗？`)) {
                return;
            }

            try {
                const response = await fetch(`/device/remove?id=${deviceId}`);
                const data = await response.json();

                if (data.success) {
                    delete deviceData[deviceId];
                    renderDeviceList();
                } else {
                    alert('删除设备失败: ' + (data.message || '未知错误'));
                }
            } catch (error) {
                console.error('删除设备失败:', error);
                alert('删除设备失败，请检查网络连接');
            }
        }

        // 清除所有设备
        async function clearAllDevices() {
            if (!confirm('确定要清除所有设备吗？此操作不可撤销！')) {
                return;
            }

            try {
                const response = await fetch(`/device/clear`);
                const data = await response.json();

                if (data.success) {
                    deviceData = {};
                    renderDeviceList();
                } else {
                    alert('清除设备失败: ' + (data.message || '未知错误'));
                }
            } catch (error) {
                console.error('清除设备失败:', error);
                alert('清除设备失败，请检查网络连接');
            }
        }

        // 切换隐私模式
        async function togglePrivateMode(isPrivate) {
            try {
                const response = await fetch(`/device/private_mode?private=${isPrivate}`);
                const data = await response.json();

                if (data.success) {
                    privateMode = isPrivate;
                } else {
                    alert('切换隐私模式失败: ' + (data.message || '未知错误'));
                    document.getElementById('private-mode-toggle').checked = privateMode;
                }
            } catch (error) {
                console.error('切换隐私模式失败:', error);
                alert('切换隐私模式失败，请检查网络连接');
                document.getElementById('private-mode-toggle').checked = privateMode;
            }
        }

        // 获取统计数据
        async function fetchMetrics() {
            try {
                const response = await fetch('/metrics');
                const data = await response.json();

                const container = document.getElementById('metrics-container');
                container.innerHTML = '';

                // 今日访问
                if (data.today) {
                    if (data.today['/']) {
                        addMetricCard(container, '今日首页访问量', data.today['/'] || 0);
                    }
                    let apiCalls = 0;
                    for (const [path, count] of Object.entries(data.today)) {
                        if (path.startsWith('/') && path !== '/') {
                            apiCalls += count;
                        }
                    }
                    addMetricCard(container, '今日 API 调用次数', apiCalls);
                }

                // 本月访问
                if (data.month) {
                    if (data.month['/']) {
                        addMetricCard(container, '本月首页访问量', data.month['/'] || 0);
                    }
                    let apiCalls = 0;
                    for (const [path, count] of Object.entries(data.month)) {
                        if (path.startsWith('/') && path !== '/') {
                            apiCalls += count;
                        }
                    }
                    addMetricCard(container, '本月 API 调用次数', apiCalls);
                }

                // 本年访问
                if (data.year) {
                    if (data.year['/']) {
                        addMetricCard(container, '本年首页访问量', data.year['/'] || 0);
                    }
                    let apiCalls = 0;
                    for (const [path, count] of Object.entries(data.year)) {
                        if (path.startsWith('/') && path !== '/') {
                            apiCalls += count;
                        }
                    }
                    addMetricCard(container, '本年 API 调用次数', apiCalls);
                }

                // 总访问
                if (data.total) {
                    if (data.total['/']) {
                        addMetricCard(container, '首页总访问量', data.total['/'] || 0);
                    }
                    let apiCalls = 0;
                    for (const [path, count] of Object.entries(data.total)) {
                        if (path.startsWith('/') && path !== '/') {
                            apiCalls += count;
                        }
                    }
                    addMetricCard(container, 'API 总调用次数', apiCalls);
                }

            } catch (error) {
                console.error('获取统计数据失败:', error);
                const container = document.getElementById('metrics-container');
                container.innerHTML = '<p>获取统计数据失败，请刷新页面重试</p>';
            }
        }

        // 添加统计卡片
        function addMetricCard(container, label, value) {
            const card = document.createElement('div');
            card.className = 'metric-card';
            card.innerHTML = `
                <div class="metric-value">${value}</div>
                <div class="metric-label">${label}</div>
            `;
            container.appendChild(card);
        }

        // 保存数据
        async function saveData() {
            try {
                const response = await fetch('/save_data');
                const data = await response.json();

                if (data.success) {
                    alert('数据保存成功！');
                } else {
                    alert('保存数据失败: ' + (data.message || '未知错误'));
                }
            } catch (error) {
                console.error('保存数据失败:', error);
                alert('保存数据失败，请检查网络连接');
            }
        }

        // 退出登录
        function logout() {
            // 清除本地存储的密钥
            localStorage.removeItem('sleepy_secret');
            // 重定向到退出登录路由，该路由会清除 cookie
            window.location.href = '/webui/logout';
        }

        // switchTheme 函数现在在 theme.js 中定义

        // 初始化页面
        window.onload = initPage;
    </script>
</body>

</html>